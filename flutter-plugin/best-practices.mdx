---
title: "最佳实践"
description: "SPAvatarKit Flutter 插件开发最佳实践指南"
---

## 性能优化

### 内存管理

<Warning>
正确的资源管理对于防止内存泄漏和应用崩溃至关重要。
</Warning>

#### 及时释放资源

```dart title="正确的资源释放"
class CharacterPage extends StatefulWidget {
  @override
  _CharacterPageState createState() => _CharacterPageState();
}

class _CharacterPageState extends State<CharacterPage> {
  final GlobalKey<State<CharacterWidget>> _characterKey =
      GlobalKey<State<CharacterWidget>>();
  CharacterController? _characterController;

  @override
  void dispose() {
    // 必须在 dispose 中关闭控制器
    _characterController?.close();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: CharacterWidget.createWithController(
        key: _characterKey,
        sessionToken: 'your_session_token',
        loadStateChanged: (state) {
          if (state == CharacterLoadState.completed) {
            _characterController = _characterKey.currentState!.controller;
          }
        },
      ),
    );
  }
}
```

#### 避免内存泄漏

<CodeGroup>
```dart 错误示例
// ❌ 错误：没有释放资源
class BadExample extends StatefulWidget {
  @override
  _BadExampleState createState() => _BadExampleState();
}

class _BadExampleState extends State<BadExample> {
  CharacterController? _controller;

  @override
  void dispose() {
    // 忘记释放控制器资源
    super.dispose();
  }
}
```

```dart 正确示例
// ✅ 正确：完整的资源管理
class GoodExample extends StatefulWidget {
  @override
  _GoodExampleState createState() => _GoodExampleState();
}

class _GoodExampleState extends State<GoodExample> {
  CharacterController? _controller;
  Timer? _heartbeatTimer;

  @override
  void dispose() {
    // 取消定时器
    _heartbeatTimer?.cancel();
    // 关闭控制器
    _controller?.close();
    super.dispose();
  }
}
```
</CodeGroup>

### 渲染优化

#### 合理使用 Widget 生命周期

```dart title="优化的 Widget 实现"
class OptimizedCharacterWidget extends StatefulWidget {
  final String sessionToken;
  final String characterId;

  const OptimizedCharacterWidget({
    Key? key,
    required this.sessionToken,
    required this.characterId,
  }) : super(key: key);

  @override
  _OptimizedCharacterWidgetState createState() =>
      _OptimizedCharacterWidgetState();
}

class _OptimizedCharacterWidgetState extends State<OptimizedCharacterWidget>
    with WidgetsBindingObserver {
  final GlobalKey<State<CharacterWidget>> _characterKey =
      GlobalKey<State<CharacterWidget>>();
  CharacterController? _controller;
  bool _isAppInForeground = true;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    _controller?.close();
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    super.didChangeAppLifecycleState(state);
    
    switch (state) {
      case AppLifecycleState.paused:
      case AppLifecycleState.inactive:
        _isAppInForeground = false;
        // 暂停渲染以节省资源
        _controller?.pause();
        break;
      case AppLifecycleState.resumed:
        _isAppInForeground = true;
        // 恢复渲染
        _controller?.resume();
        break;
      default:
        break;
    }
  }

  @override
  Widget build(BuildContext context) {
    return CharacterWidget.createWithController(
      key: _characterKey,
      sessionToken: widget.sessionToken,
      loadStateChanged: _handleLoadStateChanged,
      connectionStateChanged: _handleConnectionStateChanged,
    );
  }

  void _handleLoadStateChanged(CharacterLoadState state) {
    if (state == CharacterLoadState.completed) {
      _controller = _characterKey.currentState!.controller;
      // 加载完成后立即加载数字人
      _controller!.loadCharacter(widget.characterId);
    }
  }

  void _handleConnectionStateChanged(CharacterConnectionState state) {
    if (state == CharacterConnectionState.connected && _isAppInForeground) {
      // 只在应用前台时启动
      _controller?.start();
    }
  }
}
```

## 错误处理

### 全面的错误处理策略

```dart title="完整的错误处理实现"
class RobustCharacterWidget extends StatefulWidget {
  @override
  _RobustCharacterWidgetState createState() => _RobustCharacterWidgetState();
}

class _RobustCharacterWidgetState extends State<RobustCharacterWidget> {
  final GlobalKey<State<CharacterWidget>> _characterKey =
      GlobalKey<State<CharacterWidget>>();
  CharacterController? _controller;
  String? _lastError;
  int _retryCount = 0;
  static const int _maxRetries = 3;

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Expanded(
          child: CharacterWidget.createWithController(
            key: _characterKey,
            sessionToken: 'your_session_token',
            loadStateChanged: _handleLoadStateChanged,
            connectionStateChanged: _handleConnectionStateChanged,
            conversationStateChanged: _handleConversationStateChanged,
            playerStateChanged: _handlePlayerStateChanged,
            didEncounteredPlayerError: _handlePlayerError,
          ),
        ),
        if (_lastError != null) _buildErrorWidget(),
      ],
    );
  }

  void _handleLoadStateChanged(CharacterLoadState state) {
    switch (state) {
      case CharacterLoadState.loading:
        _clearError();
        break;
      case CharacterLoadState.completed:
        _controller = _characterKey.currentState!.controller;
        _retryCount = 0; // 重置重试计数
        break;
      case CharacterLoadState.failed:
        _handleError('数字人加载失败');
        break;
    }
  }

  void _handleConnectionStateChanged(CharacterConnectionState state) {
    switch (state) {
      case CharacterConnectionState.connecting:
        _clearError();
        break;
      case CharacterConnectionState.connected:
        _retryCount = 0;
        break;
      case CharacterConnectionState.error:
        _handleError('服务连接失败');
        break;
      case CharacterConnectionState.disconnected:
        if (_retryCount < _maxRetries) {
          _retryConnection();
        } else {
          _handleError('连接断开，已达到最大重试次数');
        }
        break;
    }
  }

  void _handleConversationStateChanged(CharacterConversationState state) {
    // 处理对话状态变化
    debugPrint('对话状态: $state');
  }

  void _handlePlayerStateChanged(CharacterPlayerState state) {
    // 处理播放器状态变化
    debugPrint('播放器状态: $state');
  }

  void _handlePlayerError(CharacterPlayerError error) {
    String errorMessage;
    switch (error) {
      case CharacterPlayerError.sdkNotVerified:
        errorMessage = 'SDK 认证失败，请检查 sessionToken';
        break;
      case CharacterPlayerError.characterIdWrong:
        errorMessage = '数字人 ID 错误，请检查 characterId';
        break;
      case CharacterPlayerError.serviceError:
        errorMessage = '服务器错误，请稍后重试';
        break;
      case CharacterPlayerError.requestTimeout:
        errorMessage = '请求超时，请检查网络连接';
        break;
      default:
        errorMessage = '未知错误: $error';
    }
    _handleError(errorMessage);
  }

  void _handleError(String error) {
    setState(() {
      _lastError = error;
    });
    debugPrint('错误: $error');
  }

  void _clearError() {
    if (_lastError != null) {
      setState(() {
        _lastError = null;
      });
    }
  }

  void _retryConnection() {
    _retryCount++;
    debugPrint('重试连接 ($_retryCount/$_maxRetries)');
    
    // 延迟重试
    Future.delayed(Duration(seconds: _retryCount * 2), () {
      _controller?.start();
    });
  }

  Widget _buildErrorWidget() {
    return Container(
      padding: EdgeInsets.all(16),
      color: Colors.red.shade100,
      child: Row(
        children: [
          Icon(Icons.error, color: Colors.red),
          SizedBox(width: 8),
          Expanded(
            child: Text(
              _lastError!,
              style: TextStyle(color: Colors.red.shade800),
            ),
          ),
          TextButton(
            onPressed: () {
              _clearError();
              _controller?.start();
            },
            child: Text('重试'),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _controller?.close();
    super.dispose();
  }
}
```

### 网络错误处理

```dart title="网络状态监控"
import 'package:connectivity_plus/connectivity_plus.dart';

class NetworkAwareCharacterWidget extends StatefulWidget {
  @override
  _NetworkAwareCharacterWidgetState createState() =>
      _NetworkAwareCharacterWidgetState();
}

class _NetworkAwareCharacterWidgetState
    extends State<NetworkAwareCharacterWidget> {
  late StreamSubscription<ConnectivityResult> _connectivitySubscription;
  bool _isConnected = true;
  CharacterController? _controller;

  @override
  void initState() {
    super.initState();
    _initConnectivityListener();
  }

  void _initConnectivityListener() {
    _connectivitySubscription = Connectivity()
        .onConnectivityChanged
        .listen((ConnectivityResult result) {
      bool wasConnected = _isConnected;
      _isConnected = result != ConnectivityResult.none;
      
      if (!wasConnected && _isConnected) {
        // 网络恢复，重新连接
        _controller?.start();
      } else if (wasConnected && !_isConnected) {
        // 网络断开，显示提示
        _showNetworkError();
      }
    });
  }

  void _showNetworkError() {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('网络连接已断开，请检查网络设置'),
        backgroundColor: Colors.orange,
        action: SnackBarAction(
          label: '重试',
          onPressed: () {
            _controller?.start();
          },
        ),
      ),
    );
  }

  @override
  void dispose() {
    _connectivitySubscription.cancel();
    _controller?.close();
    super.dispose();
  }

  // ... Widget build 方法
}
```

## 状态管理

### 使用状态管理库

<Tabs>
<Tab title="Provider">
```dart title="使用 Provider 管理状态"
import 'package:provider/provider.dart';

class CharacterState extends ChangeNotifier {
  CharacterController? _controller;
  CharacterLoadState _loadState = CharacterLoadState.idle;
  CharacterConnectionState _connectionState = CharacterConnectionState.disconnected;
  String? _error;

  // Getters
  CharacterController? get controller => _controller;
  CharacterLoadState get loadState => _loadState;
  CharacterConnectionState get connectionState => _connectionState;
  String? get error => _error;
  bool get isReady => _controller != null && 
                     _loadState == CharacterLoadState.completed &&
                     _connectionState == CharacterConnectionState.connected;

  void setController(CharacterController controller) {
    _controller = controller;
    notifyListeners();
  }

  void updateLoadState(CharacterLoadState state) {
    _loadState = state;
    notifyListeners();
  }

  void updateConnectionState(CharacterConnectionState state) {
    _connectionState = state;
    notifyListeners();
  }

  void setError(String? error) {
    _error = error;
    notifyListeners();
  }

  void clearError() {
    _error = null;
    notifyListeners();
  }

  @override
  void dispose() {
    _controller?.close();
    super.dispose();
  }
}

// 在 Widget 中使用
class CharacterPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return ChangeNotifierProvider(
      create: (_) => CharacterState(),
      child: Consumer<CharacterState>(
        builder: (context, characterState, child) {
          return Scaffold(
            body: Column(
              children: [
                Expanded(
                  child: CharacterWidget.createWithController(
                    sessionToken: 'your_token',
                    loadStateChanged: characterState.updateLoadState,
                    connectionStateChanged: characterState.updateConnectionState,
                  ),
                ),
                _buildControlPanel(characterState),
              ],
            ),
          );
        },
      ),
    );
  }

  Widget _buildControlPanel(CharacterState state) {
    return Container(
      padding: EdgeInsets.all(16),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
        children: [
          ElevatedButton(
            onPressed: state.isReady ? () => state.controller!.start() : null,
            child: Text('开始'),
          ),
          ElevatedButton(
            onPressed: state.isReady ? () => state.controller!.stop() : null,
            child: Text('停止'),
          ),
        ],
      ),
    );
  }
}
```
</Tab>

<Tab title="Riverpod">
```dart title="使用 Riverpod 管理状态"
import 'package:flutter_riverpod/flutter_riverpod.dart';

// 状态提供者
final characterControllerProvider = StateProvider<CharacterController?>((ref) => null);
final loadStateProvider = StateProvider<CharacterLoadState>((ref) => CharacterLoadState.idle);
final connectionStateProvider = StateProvider<CharacterConnectionState>((ref) => CharacterConnectionState.disconnected);

// 计算属性
final isReadyProvider = Provider<bool>((ref) {
  final controller = ref.watch(characterControllerProvider);
  final loadState = ref.watch(loadStateProvider);
  final connectionState = ref.watch(connectionStateProvider);
  
  return controller != null &&
         loadState == CharacterLoadState.completed &&
         connectionState == CharacterConnectionState.connected;
});

class CharacterPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final isReady = ref.watch(isReadyProvider);
    final controller = ref.watch(characterControllerProvider);
    
    return Scaffold(
      body: Column(
        children: [
          Expanded(
            child: CharacterWidget.createWithController(
              sessionToken: 'your_token',
              loadStateChanged: (state) {
                ref.read(loadStateProvider.notifier).state = state;
              },
              connectionStateChanged: (state) {
                ref.read(connectionStateProvider.notifier).state = state;
              },
            ),
          ),
          Container(
            padding: EdgeInsets.all(16),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              children: [
                ElevatedButton(
                  onPressed: isReady ? () => controller!.start() : null,
                  child: Text('开始'),
                ),
                ElevatedButton(
                  onPressed: isReady ? () => controller!.stop() : null,
                  child: Text('停止'),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
```
</Tab>
</Tabs>

## 音频处理最佳实践

### 音频数据处理

```dart title="优化的音频处理"
import 'dart:typed_data';
import 'package:permission_handler/permission_handler.dart';

class AudioManager {
  static const int _sampleRate = 16000;
  static const int _bufferSize = 1024;
  
  CharacterController? _controller;
  bool _isRecording = false;
  
  Future<bool> requestMicrophonePermission() async {
    final status = await Permission.microphone.request();
    return status == PermissionStatus.granted;
  }
  
  Future<void> startAudioCapture() async {
    if (!await requestMicrophonePermission()) {
      throw Exception('麦克风权限被拒绝');
    }
    
    if (_controller == null) {
      throw Exception('CharacterController 未初始化');
    }
    
    _isRecording = true;
    
    // 这里应该实现实际的音频捕获逻辑
    // 示例：使用 audio_session 或其他音频库
    _startAudioStream();
  }
  
  void _startAudioStream() {
    // 模拟音频流处理
    Timer.periodic(Duration(milliseconds: 64), (timer) {
      if (!_isRecording) {
        timer.cancel();
        return;
      }
      
      // 模拟音频数据
      final audioData = _generateAudioData();
      _controller?.sendAudioData(audioData);
    });
  }
  
  Uint8List _generateAudioData() {
    // 这里应该是实际的音频数据
    // 示例：返回模拟数据
    return Uint8List.fromList(List.generate(_bufferSize, (i) => i % 256));
  }
  
  void stopAudioCapture() {
    _isRecording = false;
  }
  
  void setController(CharacterController controller) {
    _controller = controller;
  }
  
  void dispose() {
    stopAudioCapture();
    _controller = null;
  }
}
```

### 音频质量优化

```dart title="音频质量控制"
class AudioQualityManager {
  static const Map<String, int> _qualitySettings = {
    'low': 8000,    // 8kHz
    'medium': 16000, // 16kHz
    'high': 44100,   // 44.1kHz
  };
  
  String _currentQuality = 'medium';
  
  void setAudioQuality(String quality) {
    if (_qualitySettings.containsKey(quality)) {
      _currentQuality = quality;
    }
  }
  
  int get sampleRate => _qualitySettings[_currentQuality]!;
  
  // 根据网络状况自动调整质量
  void adjustQualityBasedOnNetwork(ConnectivityResult connectivity) {
    switch (connectivity) {
      case ConnectivityResult.wifi:
        setAudioQuality('high');
        break;
      case ConnectivityResult.mobile:
        setAudioQuality('medium');
        break;
      case ConnectivityResult.ethernet:
        setAudioQuality('high');
        break;
      default:
        setAudioQuality('low');
    }
  }
}
```

## 测试策略

### 单元测试

```dart title="test/character_widget_test.dart"
import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';

class MockCharacterController extends Mock implements CharacterController {}

void main() {
  group('CharacterWidget Tests', () {
    late MockCharacterController mockController;
    
    setUp(() {
      mockController = MockCharacterController();
    });
    
    testWidgets('should handle load state changes correctly', (tester) async {
      // 测试加载状态变化
      bool loadStateChanged = false;
      
      await tester.pumpWidget(
        MaterialApp(
          home: CharacterWidget.createWithController(
            sessionToken: 'test_token',
            loadStateChanged: (state) {
              loadStateChanged = true;
            },
          ),
        ),
      );
      
      // 验证 Widget 创建成功
      expect(find.byType(CharacterWidget), findsOneWidget);
    });
    
    test('should dispose controller properly', () {
      // 测试资源释放
      when(mockController.close()).thenReturn(null);
      
      mockController.close();
      
      verify(mockController.close()).called(1);
    });
  });
}
```

### 集成测试

```dart title="integration_test/character_integration_test.dart"
import 'package:flutter/services.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();
  
  group('Character Integration Tests', () {
    testWidgets('complete character loading flow', (tester) async {
      // 启动应用
      await tester.pumpWidget(MyApp());
      
      // 等待初始化完成
      await tester.pumpAndSettle();
      
      // 查找并点击加载按钮
      final loadButton = find.text('加载数字人');
      expect(loadButton, findsOneWidget);
      
      await tester.tap(loadButton);
      await tester.pumpAndSettle();
      
      // 验证加载状态
      expect(find.text('加载中...'), findsOneWidget);
      
      // 等待加载完成（模拟）
      await tester.pump(Duration(seconds: 3));
      
      // 验证加载完成状态
      expect(find.text('加载完成'), findsOneWidget);
    });
  });
}
```

## 部署和发布

### 构建优化

```yaml title="pubspec.yaml 优化配置"
name: your_app
description: Your app description

version: 1.0.0+1

environment:
  sdk: '>=3.8.1 <4.0.0'
  flutter: '>=3.3.0'

dependencies:
  flutter:
    sdk: flutter
  sp_character_plugin:
    path: ../sp_character_plugin
  
  # 状态管理
  provider: ^6.0.5
  
  # 网络监控
  connectivity_plus: ^4.0.2
  
  # 权限管理
  permission_handler: ^10.4.3

dev_dependencies:
  flutter_test:
    sdk: flutter
  integration_test:
    sdk: flutter
  mockito: ^5.4.2
  build_runner: ^2.4.6

flutter:
  uses-material-design: true
  
  # 资源优化
  assets:
    - assets/images/
    - assets/icons/
```

### 性能监控

```dart title="性能监控实现"
import 'package:flutter/foundation.dart';

class PerformanceMonitor {
  static final Map<String, Stopwatch> _timers = {};
  
  static void startTimer(String name) {
    _timers[name] = Stopwatch()..start();
  }
  
  static void endTimer(String name) {
    final timer = _timers[name];
    if (timer != null) {
      timer.stop();
      debugPrint('$name 耗时: ${timer.elapsedMilliseconds}ms');
      _timers.remove(name);
    }
  }
  
  static void logMemoryUsage() {
    if (kDebugMode) {
      final info = ProcessInfo.currentRss;
      debugPrint('当前内存使用: ${info ~/ 1024 ~/ 1024}MB');
    }
  }
}

// 使用示例
class MonitoredCharacterWidget extends StatefulWidget {
  @override
  _MonitoredCharacterWidgetState createState() =>
      _MonitoredCharacterWidgetState();
}

class _MonitoredCharacterWidgetState extends State<MonitoredCharacterWidget> {
  @override
  void initState() {
    super.initState();
    PerformanceMonitor.startTimer('character_init');
  }
  
  void _handleLoadStateChanged(CharacterLoadState state) {
    if (state == CharacterLoadState.completed) {
      PerformanceMonitor.endTimer('character_init');
      PerformanceMonitor.logMemoryUsage();
    }
  }
  
  // ... 其他代码
}
```

## 总结

<Check>
遵循这些最佳实践将帮助您构建稳定、高性能的数字人应用。
</Check>

### 关键要点

1. **资源管理**: 始终在 `dispose` 方法中释放 `CharacterController`
2. **错误处理**: 实现全面的错误处理和重试机制
3. **状态管理**: 使用适当的状态管理库管理复杂状态
4. **性能优化**: 监控内存使用和渲染性能
5. **测试**: 编写单元测试和集成测试确保代码质量

### 下一步

- [API 参考](/flutter-plugin/api-reference) - 查看完整的 API 文档
- [常见问题](/flutter-plugin/faq) - 解决常见问题
- [快速开始](/flutter-plugin/quickstart) - 快速集成指南

<Tip>
建议在开发过程中定期检查内存使用情况，并在生产环境中实施性能监控。
</Tip>